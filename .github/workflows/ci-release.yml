name: CI (Release)
on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest

    outputs:
      artifact-id: ${{ steps.upload-artifact.outputs.artifact-id }}

    steps:
    - uses: actions/checkout@v6
      with:
        submodules: true

    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '6.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build -c Release --no-restore

    - name: Publish
      run: dotnet publish -p:PublishSingleFile=true -p:CommitHash=${{ github.sha }} -p:CommitRef=${{ github.ref_type }}/${{ github.ref_name }} -r win-x64 -c Release --self-contained false .\Bloxstrap\Bloxstrap.csproj

    - name: Upload artifact
      id: upload-artifact
      uses: actions/upload-artifact@v6
      with:
        name: Bloxstrap (Release) (${{ github.sha }})
        path: .\Bloxstrap\bin\Release\net6.0-windows\win-x64\publish\*

  release:
    permissions:
      contents: write
    needs: build
    runs-on: ubuntu-slim
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v6
        with:
          name: Bloxstrap (Release) (${{ github.sha }})
          path: release

      - name: Rename binaries
        run: mv release/Bloxstrap.exe Johnstrap-${{ github.ref_name }}.exe

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: Johnstrap-${{ github.ref_name }}.exe
          name: Johnstrap ${{ github.ref_name }}

  release-test:
    needs: build
    runs-on: ubuntu-slim
    if: startsWith(github.ref, 'refs/tags/release-test')

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v6
        with:
          name: Johnstrap (Release) (${{ github.sha }})
          path: release

      - name: Rename binaries
        run: mv release/Bloxstrap.exe Johnstrap-${{ github.ref_name }}.exe

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: Johnstrap-${{ github.ref_name }}.exe
          name: Johnstrap ${{ github.ref_name }}

  notify:
    needs: [build, release, release-test]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.build.result }}" == "failure" ] || [ "${{ needs.release.result }}" == "failure" ] || [ "${{ needs.release-test.result }}" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=15548997" >> $GITHUB_OUTPUT
          elif [ "${{ needs.build.result }}" == "cancelled" ] || [ "${{ needs.release.result }}" == "cancelled" ] || [ "${{ needs.release-test.result }}" == "cancelled" ]; then
            echo "status=cancelled" >> $GITHUB_OUTPUT
            echo "color=9807270" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=3066993" >> $GITHUB_OUTPUT
          fi

      - name: Determine notification message
        id: message
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "title=Workflow ${{ steps.status.outputs.status }}" >> $GITHUB_OUTPUT
            echo "description=**CI (Release)** workflow has completed" >> $GITHUB_OUTPUT
          else
            echo "title=Builds passing" >> $GITHUB_OUTPUT
            echo "description=**CI (Release)** builds are passing" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "${{ steps.message.outputs.title }}",
                "description": "${{ steps.message.outputs.description }}",
                "color": ${{ steps.status.outputs.color }},
                "fields": [
                  {
                    "name": "Repository",
                    "value": "${{ github.repository }}",
                    "inline": true
                  },
                  {
                    "name": "Branch/Tag",
                    "value": "${{ github.ref_name }}",
                    "inline": true
                  },
                  {
                    "name": "Triggered by",
                    "value": "${{ github.actor }}",
                    "inline": true
                  },
                  {
                    "name": "Status",
                    "value": "${{ steps.status.outputs.status }}",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "[${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})",
                    "inline": false
                  },
                  {
                    "name": "Workflow Run",
                    "value": "[View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                    "inline": false
                  }
                ],
                "timestamp": "${{ github.event.head_commit.timestamp }}"
              }]
            }'
